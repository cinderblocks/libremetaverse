name: CI Build

on:
  push:
    branches: [ master ]
    tags: ['v*']
  workflow_dispatch: {}

jobs:
build:
  name: Build and pack
  runs-on: windows-2022
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Dotnet --info
      run: dotnet --info

    - name: Restore
      run: dotnet restore LibreMetaverse.sln

    - name: Build
      run: dotnet build LibreMetaverse.sln --configuration Release --no-restore --verbosity minimal

    - name: Pack
      run: dotnet pack LibreMetaverse.sln -c Release -o ./artifacts --no-build

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: artifacts/*.nupkg

publish:
  name: Publish Packages (on tag)
  needs: build
  if: ${{ startsWith(github.ref, 'refs/tags/') }}
  runs-on: windows-2022
  permissions:
    contents: write
  steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./artifacts

    - name: List artifacts
      run: Get-ChildItem -Path artifacts -Recurse

    - name: Publish to NuGet.org
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      shell: pwsh
      run: |
        if (-not $env:NUGET_API_KEY) {
          Write-Host "NUGET_API_KEY not set, skipping NuGet publish"
        }
        else {
          Write-Host "Publishing packages to NuGet.org"
          dotnet nuget push "artifacts\*.nupkg" -k $env:NUGET_API_KEY -s https://api.nuget.org/v3/index.json --skip-duplicate
          if (Test-Path "artifacts\*.snupkg") {
            Write-Host "Publishing symbol packages to NuGet.org"
            dotnet nuget push "artifacts\*.snupkg" -k $env:NUGET_API_KEY -s https://api.nuget.org/v3/index.json --skip-duplicate
          }
        }

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: 'artifacts/*.nupkg,artifacts/*.snupkg'
        token: ${{ secrets.GITHUB_TOKEN }}
        generateReleaseNotes: true
